(function(){function e(){function k(t,n,r){var i=[{x:0,y:0},{x:e[0],y:e[1]}],s=n.x,o=n.y,u=Math.sqrt(e[0]*e[0]+e[1]*e[1]),f=E(e),c=Math.random()<.5?1:-1,h=-c,p,d,v;while(p=f(h+=c)){d=~~p[0];v=~~p[1];if(Math.min(d,v)>u)break;n.x=s+d;n.y=o+v;if(n.x+n.x0<0||n.y+n.y0<0||n.x+n.x1>e[0]||n.y+n.y1>e[1])continue;if(!r||!a(n,t,e[0])){if(!r||l(n,r)){var m=n.sprite,g=n.width>>5,y=e[0]>>5,b=n.x-(g<<4),w=b&127,S=32-w,x=n.y1-n.y0,T=(n.y+n.y0)*y+(b>>5),N;for(var C=0;C<x;C++){N=0;for(var k=0;k<=g;k++){t[T+k]|=N<<S|(k<g?(N=m[C*g+k])>>>w:0)}T+=y}delete n.sprite;return true}}}return false}var e=[256,256],h=t,d=n,v=i,m=r,g=r,y=s,b=o,E=c,S=[],x=Infinity,T=d3.dispatch("word","end"),N=null,C={};C.start=function(){function a(){var a=+(new Date),l;while(+(new Date)-a<x&&++i<r&&N){l=o[i];l.x=e[0]*(Math.random()+.5)>>1;l.y=e[1]*(Math.random()+.5)>>1;u(l,o,i);if(l.hasText&&k(t,l,n)){s.push(l);T.word(l);if(n)f(n,l);else n=[{x:l.x+l.x0,y:l.y+l.y0},{x:l.x+l.x1,y:l.y+l.y1}];l.x-=e[0]>>1;l.y-=e[1]>>1}}if(i>=r){C.stop();T.end(s,n)}}var t=p((e[0]>>5)*e[1]),n=null,r=S.length,i=-1,s=[],o=S.map(function(e,t){e.text=h.call(this,e,t);e.font=d.call(this,e,t);e.style=m.call(this,e,t);e.weight=g.call(this,e,t);e.rotate=y.call(this,e,t);e.size=~~v.call(this,e,t);e.padding=b.call(this,e,t);return e}).sort(function(e,t){return t.size-e.size});if(N)clearInterval(N);N=setInterval(a,0);a();return C};C.stop=function(){if(N){clearInterval(N);N=null}return C};C.timeInterval=function(e){if(!arguments.length)return x;x=e==null?Infinity:e;return C};C.words=function(e){if(!arguments.length)return S;S=e;return C};C.size=function(t){if(!arguments.length)return e;e=[+t[0],+t[1]];return C};C.font=function(e){if(!arguments.length)return d;d=d3.functor(e);return C};C.fontStyle=function(e){if(!arguments.length)return m;m=d3.functor(e);return C};C.fontWeight=function(e){if(!arguments.length)return g;g=d3.functor(e);return C};C.rotate=function(e){if(!arguments.length)return y;y=d3.functor(e);return C};C.text=function(e){if(!arguments.length)return h;h=d3.functor(e);return C};C.spiral=function(e){if(!arguments.length)return E;E=w[e+""]||e;return C};C.fontSize=function(e){if(!arguments.length)return v;v=d3.functor(e);return C};C.padding=function(e){if(!arguments.length)return b;b=d3.functor(e);return C};return d3.rebind(C,T,"on")}function t(e){return e.text}function n(){return"serif"}function r(){return"normal"}function i(e){return Math.sqrt(e.value)}function s(){return(~~(Math.random()*6)-3)*30}function o(){return 1}function u(e,t,n){if(e.sprite)return;b.clearRect(0,0,(v<<5)/y,m/y);var r=0,i=0,s=0,o=t.length;--n;while(++n<o){e=t[n];b.save();b.font=e.style+" "+e.weight+" "+~~((e.size+1)/y)+"px "+e.font;var u=b.measureText(e.text+"m").width*y,a=e.size<<1;if(e.rotate){var f=Math.sin(e.rotate*d),l=Math.cos(e.rotate*d),c=u*l,h=u*f,p=a*l,g=a*f;u=Math.max(Math.abs(c+g),Math.abs(c-g))+31>>5<<5;a=~~Math.max(Math.abs(h+p),Math.abs(h-p))}else{u=u+31>>5<<5}if(a>s)s=a;if(r+u>=v<<5){r=0;i+=s;s=0}if(i+a>=m)break;b.translate((r+(u>>1))/y,(i+(a>>1))/y);if(e.rotate)b.rotate(e.rotate*d);b.fillText(e.text,0,0);if(e.padding)b.lineWidth=2*e.padding,b.strokeText(e.text,0,0);b.restore();e.width=u;e.height=a;e.xoff=r;e.yoff=i;e.x1=u>>1;e.y1=a>>1;e.x0=-e.x1;e.y0=-e.y1;e.hasText=true;r+=u}var w=b.getImageData(0,0,(v<<5)/y,m/y).data,E=[];while(--n>=0){e=t[n];if(!e.hasText)continue;var u=e.width,S=u>>5,a=e.y1-e.y0;for(var x=0;x<a*S;x++)E[x]=0;r=e.xoff;if(r==null)return;i=e.yoff;var T=0,N=-1;for(var C=0;C<a;C++){for(var x=0;x<u;x++){var k=S*C+(x>>5),L=w[(i+C)*(v<<5)+(r+x)<<2]?1<<31-x%32:0;E[k]|=L;T|=L}if(T)N=C;else{e.y0++;a--;C--;i++}}e.y1=e.y0+N;e.sprite=E.slice(0,(e.y1-e.y0)*S)}}function a(e,t,n){n>>=5;var r=e.sprite,i=e.width>>5,s=e.x-(i<<4),o=s&127,u=32-o,a=e.y1-e.y0,f=(e.y+e.y0)*n+(s>>5),l;for(var c=0;c<a;c++){l=0;for(var h=0;h<=i;h++){if((l<<u|(h<i?(l=r[c*i+h])>>>o:0))&t[f+h])return true}f+=n}return false}function f(e,t){var n=e[0],r=e[1];if(t.x+t.x0<n.x)n.x=t.x+t.x0;if(t.y+t.y0<n.y)n.y=t.y+t.y0;if(t.x+t.x1>r.x)r.x=t.x+t.x1;if(t.y+t.y1>r.y)r.y=t.y+t.y1}function l(e,t){return e.x+e.x1>t[0].x&&e.x+e.x0<t[1].x&&e.y+e.y1>t[0].y&&e.y+e.y0<t[1].y}function c(e){var t=e[0]/e[1];return function(e){return[t*(e*=.1)*Math.cos(e),e*Math.sin(e)]}}function h(e){var t=4,n=t*e[0]/e[1],r=0,i=0;return function(e){var s=e<0?-1:1;switch(Math.sqrt(1+4*s*e)-s&3){case 0:r+=n;break;case 1:i+=t;break;case 2:r-=n;break;default:i-=t;break}return[r,i]}}function p(e){var t=[],n=-1;while(++n<e)t[n]=0;return t}var d=Math.PI/180,v=1<<11>>5,m=1<<11,g,y=1;if(typeof document!=="undefined"){g=document.createElement("canvas");g.width=1;g.height=1;y=Math.sqrt(g.getContext("2d").getImageData(0,0,1,1).data.length>>2);g.width=(v<<5)/y;g.height=m/y}else{g=new Canvas(v<<5,m)}var b=g.getContext("2d"),w={archimedean:c,rectangular:h};b.fillStyle=b.strokeStyle="red";b.textAlign="center";if(typeof module==="object"&&module.exports)module.exports=e;else(d3.layout||(d3.layout={})).cloud=e})()